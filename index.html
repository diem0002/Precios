<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta de Bodegas</title>
    <link rel="icon" href="img/compañia de vinos logos_Mesa de trabajo 1.ico" type="image/x-icon">
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

  <style>
    /* Paleta de colores */
    :root {
      --lola: #dccdd5;
      --bouquet: #b494a4;
      --tawny-port: #642444;
      --strikemaster: #8d5e75;
      --mountbatten-pink-1: #a48494;
      --mountbatten-pink-2: #9c7c8c;
      --au-chico: #845464;
      --cosmic-1: #74445c;
      --cosmic-2: #6c344c;
      --finn: #682854;
    }

    /* Reset y base */
    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background: var(--lola);
      color: var(--tawny-port);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    /* Logo */
    .logo {
        display: block;
        margin: 0 auto 15px;
        max-width: 100px;
        width: 100%;
        height: auto;
        filter: drop-shadow(2px 2px 3px var(--cosmic-2));
        }

    h1 {
      text-align: center;
      color: var(--finn);
      margin-bottom: 25px;
      font-weight: 700;
      letter-spacing: 1.2px;
    }

    /* Scanner */
    .scanner-container {
      width: 100%;
      max-width: 400px;
      margin: 0 auto 20px;
      position: relative;
      border: 2px solid var(--cosmic-1);
      border-radius: 12px;
      overflow: hidden;
      background: var(--mountbatten-pink-1);
      box-shadow: 0 0 15px var(--cosmic-2);
    }

    #scanner, #video {
      width: 100%;
      display: block;
      border-radius: 12px;
    }

    #result {
      margin: 20px 0;
      padding: 15px 20px;
      border-radius: 10px;
      background: var(--bouquet);
      color: var(--tawny-port);
      font-weight: 600;
      box-shadow: inset 0 0 5px var(--au-chico);
      text-align: center;
      min-height: 40px;
    }

    /* Tabla */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: var(--mountbatten-pink-2);
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 15px var(--cosmic-2);
    }
    /* Ajustar ancho de la columna de precios */
    td:nth-child(3), th:nth-child(3) {
    min-width: 120px; /* Podés ajustar a 120px o más si hace falta */
     text-align: right; /* Para alinear los precios a la derecha */
    }
    th, td {
      border: 1px solid var(--au-chico);
      padding: 10px 15px;
      text-align: left;
      color: var(--lola);
      word-break: break-word;
    }

    th {
      background-color: var(--finn);
      font-weight: 700;
      letter-spacing: 0.05em;
    }

    /* Botones */
    .btn {
      background-color: var(--finn);
      color: var(--lola);
      padding: 10px 20px;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      margin: 5px;
      font-weight: 600;
      box-shadow: 0 4px 8px var(--cosmic-2);
      transition: background-color 0.3s ease;
      user-select: none;
    }
    .btn:hover {
      background-color: var(--tawny-port);
    }
    .btn:active {
      background-color: var(--cosmic-1);
      box-shadow: inset 0 0 8px var(--cosmic-2);
    }

    .btn-scan {
      background-color: var(--au-chico);
    }
    .btn-scan:hover {
      background-color: var(--strikemaster);
    }

    /* Ocultar elementos */
    .hidden {
      display: none !important;
    }

    /* Cargando */
    .loading {
      text-align: center;
      padding: 20px;
      color: var(--tawny-port);
      font-weight: 600;
    }

    /* Responsive */
    @media (max-width: 480px) {
      body {
        padding: 10px;
      }

      .btn {
        width: 100%;
        padding: 12px 0;
        font-size: 1.1rem;
      }

      table, th, td {
        font-size: 0.9rem;
      }

      h1 {
        font-size: 1.8rem;
      }

      .scanner-container {
        max-width: 100%;
      }
    }
  </style>
</head>
<body>
    <img src="img/compañia de vinos logos-03.png" alt="Logo de la vinoteca" class="logo">
    <h1>Consulta de Productos por Bodega</h1>
    
    <div id="scanner-section">
        <button id="startScanner" class="btn btn-scan">Iniciar Escáner QR</button>
        <div class="scanner-container hidden" id="scannerContainer">
            <canvas id="scanner" class="hidden"></canvas>
            <video id="video" width="100%" autoplay playsinline class="hidden"></video>
            <button id="stopScanner" class="btn">Detener Escáner</button>
        </div>
    </div>
    
    <div id="result">Escanea un código QR para ver los productos de la bodega</div>
    
    <div id="loading" class="loading hidden">
        <p>Cargando datos...</p>
    </div>
    
    <div id="products-container" class="hidden">
        <h2>Productos en Bodega: <span id="bodega-name"></span></h2>
        <table id="products-table">
            <thead>
                <tr>
                    <th>Producto</th>
                    <th>Bodega</th>
                    <th>Precio</th>
                </tr>
            </thead>
            <tbody id="products-body">
                <!-- Los productos se insertarán aquí -->
            </tbody>
        </table>
    </div>

    <script>
        // Reemplaza esta URL con el enlace público que generaste
        const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ5JA7l3_7kg8Eg0oXDaZYogbP9kxVzJfvypjbiUz-B4pOuUz-bHzAteAyRjbaYNQ/pub?output=csv';
        
        let productsData = [];
        let videoStream = null;
        
        document.getElementById('startScanner').addEventListener('click', startScanner);
        document.getElementById('stopScanner').addEventListener('click', stopScanner);
        
        // Cargar datos al iniciar la página
        window.addEventListener('DOMContentLoaded', () => {
            loadData();
        });
        
        async function loadData() {
            document.getElementById('loading').classList.remove('hidden');
            
            try {
                const response = await fetch(SHEET_URL);
                const csvData = await response.text();
                
                Papa.parse(csvData, {
                    header: true,
                    complete: function(results) {
                        productsData = results.data;
                        document.getElementById('loading').classList.add('hidden');
                        console.log('Datos cargados:', productsData);
                    },
                    error: function(error) {
                        console.error('Error al cargar datos:', error);
                        document.getElementById('loading').classList.add('hidden');
                        document.getElementById('result').textContent = 'Error al cargar los datos. Intenta recargar la página.';
                    }
                });
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('result').textContent = 'Error al cargar los datos. Intenta recargar la página.';
            }
        }
        
        function startScanner() {
            const scannerContainer = document.getElementById('scannerContainer');
            const video = document.getElementById('video');
            
            scannerContainer.classList.remove('hidden');
            document.getElementById('startScanner').classList.add('hidden');
            
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
                .then(function(stream) {
                    videoStream = stream;
                    video.srcObject = stream;
                    video.classList.remove('hidden');
                    video.play();
                    
                    requestAnimationFrame(tick);
                })
                .catch(function(err) {
                    console.error("Error al acceder a la cámara:", err);
                    document.getElementById('result').textContent = "No se pudo acceder a la cámara. Asegúrate de permitir el acceso.";
                });
        }
        
        function stopScanner() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            
            document.getElementById('scannerContainer').classList.add('hidden');
            document.getElementById('startScanner').classList.remove('hidden');
            document.getElementById('video').classList.add('hidden');
        }
        
        function tick() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('scanner');
            const context = canvas.getContext('2d');
            
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvas.hidden = false;
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "dontInvert",
                });
                
                if (code) {
                    stopScanner();
                    showProducts(code.data);
                }
            }
            
            requestAnimationFrame(tick);
        }
        
        function showProducts(bodegaName) {
    document.getElementById('bodega-name').textContent = bodegaName;
    document.getElementById('result').textContent = `Mostrando productos para: ${bodegaName}`;
    
    const filteredProducts = productsData.filter(product => 
        product.Bodega && product.Bodega.trim().toLowerCase() === bodegaName.trim().toLowerCase()
    );
    
    const productsBody = document.getElementById('products-body');
    productsBody.innerHTML = '';
    
    if (filteredProducts.length === 0) {
        productsBody.innerHTML = '<tr><td colspan="3">No se encontraron productos para esta bodega</td></tr>';
    } else {
        filteredProducts.forEach(product => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${product.Producto || 'N/A'}</td>
                <td>${product.Bodega || 'N/A'}</td>
                <td>${product.Precio || 'N/A'}</td>
            `;
            productsBody.appendChild(row);
        });
    }
    
    document.getElementById('products-container').classList.remove('hidden');
}

    </script>
</body>
</html>
