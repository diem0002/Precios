<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Consulta de Bodegas</title>
  <link rel="icon" href="img/compañia de vinos logos_Mesa de trabajo 1.ico" type="image/x-icon">

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #2c003e;
      color: #f3e9ff;
      margin: 0;
      padding: 0 15px;
    }

    header {
      text-align: center;
      padding: 20px;
    }

    header img {
      width: 120px;
      margin-bottom: 10px;
    }

    h1 {
      color: #a259ff;
      font-size: 1.8em;
      margin-bottom: 10px;
    }

    .scanner-container {
      max-width: 400px;
      margin: 20px auto;
      position: relative;
    }

    #scanner {
      width: 100%;
      border: 2px solid #a259ff;
    }

    #result {
      background-color: #3f0d57;
      margin: 20px auto;
      padding: 15px;
      border-radius: 8px;
      max-width: 600px;
      text-align: center;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th, td {
      border: 1px solid #a259ff;
      padding: 10px;
      text-align: left;
    }

    th {
      background-color: #5e0b7a;
      color: #fff;
    }

    td {
      background-color: #3f0d57;
    }

    .hidden {
      display: none;
    }

    .btn {
      background-color: #5e0b7a;
      color: white;
      padding: 12px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin: 10px auto;
      display: block;
      font-size: 1em;
    }

    .btn-scan {
      background-color: #a259ff;
      color: #2c003e;
    }

    .btn:hover {
      opacity: 0.85;
    }

    .loading {
      text-align: center;
      padding: 20px;
    }

    @media (max-width: 600px) {
      table, th, td {
        font-size: 0.9em;
      }

      h1 {
        font-size: 1.5em;
      }

      .btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>

  <header>
    <img src="img/compañia de vinos logos-03.png" alt="Logo de la vinoteca">
    <h1>Consulta de Productos por Bodega</h1>
  </header>

  <div id="scanner-section">
    <button id="startScanner" class="btn btn-scan">Iniciar Escáner QR</button>
    <div class="scanner-container hidden" id="scannerContainer">
      <canvas id="scanner" class="hidden"></canvas>
      <video id="video" width="100%" autoplay playsinline class="hidden"></video>
      <button id="stopScanner" class="btn">Detener Escáner</button>
    </div>
  </div>

  <div id="result">Escanea un código QR para ver los productos de la bodega</div>

  <div id="loading" class="loading hidden">
    <p>Cargando datos...</p>
  </div>

  <div id="products-container" class="hidden">
    <h2>Productos en Bodega: <span id="bodega-name"></span></h2>
    <table id="products-table">
      <thead>
        <tr>
          <th>Producto</th>
          <th>Bodega</th>
          <th>Precio</th>
        </tr>
      </thead>
      <tbody id="products-body"></tbody>
    </table>
  </div>

  <script>
    const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT021U2WLy4t8F9H-4ZafrFYTo7evHnbYHvipI0TTPlUKN5T3Puo66S5Lrcg7hlgTZGNE9V9RkXxfWO/pub?gid=1497613061&single=true&output=csv';
    
    let productsData = [];
    let videoStream = null;

    document.getElementById('startScanner').addEventListener('click', startScanner);
    document.getElementById('stopScanner').addEventListener('click', stopScanner);

    window.addEventListener('DOMContentLoaded', () => {
      loadData();
    });

    async function loadData() {
      document.getElementById('loading').classList.remove('hidden');
      try {
        const response = await fetch(SHEET_URL);
        const csvData = await response.text();

        Papa.parse(csvData, {
          header: true,
          complete: function(results) {
            productsData = results.data;
            document.getElementById('loading').classList.add('hidden');
            console.log('Datos cargados:', productsData);
          },
          error: function(error) {
            console.error('Error al cargar datos:', error);
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('result').textContent = 'Error al cargar los datos. Intenta recargar la página.';
          }
        });
      } catch (error) {
        console.error('Error:', error);
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('result').textContent = 'Error al cargar los datos. Intenta recargar la página.';
      }
    }

    function startScanner() {
      const scannerContainer = document.getElementById('scannerContainer');
      const video = document.getElementById('video');

      scannerContainer.classList.remove('hidden');
      document.getElementById('startScanner').classList.add('hidden');

      navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
        .then(function(stream) {
          videoStream = stream;
          video.srcObject = stream;
          video.classList.remove('hidden');
          video.play();
          requestAnimationFrame(tick);
        })
        .catch(function(err) {
          console.error("Error al acceder a la cámara:", err);
          document.getElementById('result').textContent = "No se pudo acceder a la cámara. Asegúrate de permitir el acceso.";
        });
    }

    function stopScanner() {
      if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
        videoStream = null;
      }
      document.getElementById('scannerContainer').classList.add('hidden');
      document.getElementById('startScanner').classList.remove('hidden');
      document.getElementById('video').classList.add('hidden');
    }

    function tick() {
      const video = document.getElementById('video');
      const canvas = document.getElementById('scanner');
      const context = canvas.getContext('2d');

      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        canvas.hidden = false;
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);

        const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, imageData.width, imageData.height, {
          inversionAttempts: "dontInvert",
        });

        if (code) {
          stopScanner();
          showProducts(code.data);
        }
      }

      requestAnimationFrame(tick);
    }

    function showProducts(bodegaName) {
      document.getElementById('bodega-name').textContent = bodegaName;
      document.getElementById('result').textContent = `Mostrando productos para: ${bodegaName}`;

      const filteredProducts = productsData.filter(product =>
        product.Bodega && product.Bodega.trim().toLowerCase() === bodegaName.trim().toLowerCase()
      );

      const productsBody = document.getElementById('products-body');
      productsBody.innerHTML = '';

      if (filteredProducts.length === 0) {
        productsBody.innerHTML = '<tr><td colspan="3">No se encontraron productos para esta bodega</td></tr>';
      } else {
        filteredProducts.forEach(product => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${product.Producto || 'N/A'}</td>
            <td>${product.Bodega || 'N/A'}</td>
            <td>${product.Precio || 'N/A'}</td>
          `;
          productsBody.appendChild(row);
        });
      }

      document.getElementById('products-container').classList.remove('hidden');
    }
  </script>
</body>
</html>
